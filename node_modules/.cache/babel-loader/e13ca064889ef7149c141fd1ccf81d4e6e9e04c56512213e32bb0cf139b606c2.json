{"ast":null,"code":"import{startOfWeek,subWeeks,format}from'date-fns';import{api}from'./api';// Event-System für Datenänderungen\nconst dataChangeCallbacks=[];const notifyDataChange=()=>{dataChangeCallbacks.forEach(callback=>callback());};export const storage={// Event-System\nonDataChange:callback=>{dataChangeCallbacks.push(callback);return()=>{const index=dataChangeCallbacks.indexOf(callback);if(index>-1){dataChangeCallbacks.splice(index,1);}};},// Abteilungen\ngetDepartments:async()=>{try{return await api.getDepartments();}catch(error){console.error('Fehler beim Laden der Abteilungen:',error);throw error;}},// Mitarbeiter\ngetEmployees:async()=>{try{return await api.getEmployees();}catch(error){console.error('Fehler beim Laden der Mitarbeiter:',error);throw error;}},addEmployee:async employee=>{try{const newEmployee=await api.addEmployee(employee);notifyDataChange();return newEmployee;}catch(error){console.error('Fehler beim Hinzufügen des Mitarbeiters:',error);throw error;}},updateEmployee:async(id,employee)=>{try{const updatedEmployee=await api.updateEmployee(id,employee);notifyDataChange();return updatedEmployee;}catch(error){console.error('Fehler beim Aktualisieren des Mitarbeiters:',error);throw error;}},deleteEmployee:async id=>{try{await api.deleteEmployee(id);notifyDataChange();}catch(error){console.error('Fehler beim Löschen des Mitarbeiters:',error);throw error;}},// Anwesenheit\ngetAttendance:async()=>{try{const attendance=await api.getAttendance();// Alte Daten bereinigen (älter als 1 Woche)\nreturn storage.cleanOldAttendanceData(attendance);}catch(error){console.error('Fehler beim Laden der Anwesenheitsdaten:',error);throw error;}},addAttendanceEntry:async entry=>{try{const newEntry=await api.addAttendanceEntry(entry);notifyDataChange();return newEntry;}catch(error){console.error('Fehler beim Speichern der Anwesenheit:',error);throw error;}},deleteAttendanceEntry:async(employeeId,date)=>{try{await api.deleteAttendanceEntry(employeeId,date);notifyDataChange();}catch(error){console.error('Fehler beim Löschen der Anwesenheit:',error);throw error;}},getAttendanceForDate:async date=>{try{const attendance=await storage.getAttendance();return attendance.filter(entry=>entry.date===date);}catch(error){console.error('Fehler beim Laden der Anwesenheit für Datum:',error);throw error;}},getAttendanceForEmployee:async(employeeId,startDate,endDate)=>{try{const attendance=await storage.getAttendance();return attendance.filter(entry=>{if(entry.employeeId!==employeeId)return false;if(startDate&&entry.date<startDate)return false;if(endDate&&entry.date>endDate)return false;return true;});}catch(error){console.error('Fehler beim Laden der Anwesenheit für Mitarbeiter:',error);throw error;}},// Alte Anwesenheitsdaten bereinigen (älter als 1 Woche)\ncleanOldAttendanceData:attendance=>{const oneWeekAgo=startOfWeek(subWeeks(new Date(),1),{weekStartsOn:1});const cutoffDate=format(oneWeekAgo,'yyyy-MM-dd');return attendance.filter(entry=>entry.date>=cutoffDate);},// Anwesenheitsdaten für nicht existierende Mitarbeiter bereinigen\ncleanOrphanedAttendanceData:async()=>{try{const employees=await storage.getEmployees();const attendance=await storage.getAttendance();const employeeIds=employees.map(emp=>emp.id);const cleanedAttendance=attendance.filter(entry=>employeeIds.includes(entry.employeeId));if(cleanedAttendance.length!==attendance.length){console.log('Bereinige verwaiste Anwesenheitsdaten:',{before:attendance.length,after:cleanedAttendance.length,removed:attendance.length-cleanedAttendance.length});// Hier könnten wir einen API-Endpunkt für das Massen-Update hinzufügen\n// Für jetzt ignorieren wir das, da es selten vorkommt\n}}catch(error){console.error('Fehler beim Bereinigen verwaister Anwesenheitsdaten:',error);}}};","map":{"version":3,"names":["startOfWeek","subWeeks","format","api","dataChangeCallbacks","notifyDataChange","forEach","callback","storage","onDataChange","push","index","indexOf","splice","getDepartments","error","console","getEmployees","addEmployee","employee","newEmployee","updateEmployee","id","updatedEmployee","deleteEmployee","getAttendance","attendance","cleanOldAttendanceData","addAttendanceEntry","entry","newEntry","deleteAttendanceEntry","employeeId","date","getAttendanceForDate","filter","getAttendanceForEmployee","startDate","endDate","oneWeekAgo","Date","weekStartsOn","cutoffDate","cleanOrphanedAttendanceData","employees","employeeIds","map","emp","cleanedAttendance","includes","length","log","before","after","removed"],"sources":["C:/Users/MoritzSteinbach/Desktop/Büroplanner/officeplan/src/utils/storage.ts"],"sourcesContent":["import { Employee, AttendanceEntry, Department } from '../types';\nimport { startOfWeek, subWeeks, format } from 'date-fns';\nimport { api, ApiError } from './api';\n\n// Event-System für Datenänderungen\nconst dataChangeCallbacks: (() => void)[] = [];\n\nconst notifyDataChange = () => {\n  dataChangeCallbacks.forEach(callback => callback());\n};\n\nexport const storage = {\n  \n  // Event-System\n  onDataChange: (callback: () => void) => {\n    dataChangeCallbacks.push(callback);\n    return () => {\n      const index = dataChangeCallbacks.indexOf(callback);\n      if (index > -1) {\n        dataChangeCallbacks.splice(index, 1);\n      }\n    };\n  },\n  \n  // Abteilungen\n  getDepartments: async (): Promise<Department[]> => {\n    try {\n      return await api.getDepartments();\n    } catch (error) {\n      console.error('Fehler beim Laden der Abteilungen:', error);\n      throw error;\n    }\n  },\n\n  // Mitarbeiter\n  getEmployees: async (): Promise<Employee[]> => {\n    try {\n      return await api.getEmployees();\n    } catch (error) {\n      console.error('Fehler beim Laden der Mitarbeiter:', error);\n      throw error;\n    }\n  },\n\n  addEmployee: async (employee: Omit<Employee, 'id'>): Promise<Employee> => {\n    try {\n      const newEmployee = await api.addEmployee(employee);\n      notifyDataChange();\n      return newEmployee;\n    } catch (error) {\n      console.error('Fehler beim Hinzufügen des Mitarbeiters:', error);\n      throw error;\n    }\n  },\n\n  updateEmployee: async (id: string, employee: Partial<Employee>): Promise<Employee> => {\n    try {\n      const updatedEmployee = await api.updateEmployee(id, employee);\n      notifyDataChange();\n      return updatedEmployee;\n    } catch (error) {\n      console.error('Fehler beim Aktualisieren des Mitarbeiters:', error);\n      throw error;\n    }\n  },\n\n  deleteEmployee: async (id: string): Promise<void> => {\n    try {\n      await api.deleteEmployee(id);\n      notifyDataChange();\n    } catch (error) {\n      console.error('Fehler beim Löschen des Mitarbeiters:', error);\n      throw error;\n    }\n  },\n\n  // Anwesenheit\n  getAttendance: async (): Promise<AttendanceEntry[]> => {\n    try {\n      const attendance = await api.getAttendance();\n      // Alte Daten bereinigen (älter als 1 Woche)\n      return storage.cleanOldAttendanceData(attendance);\n    } catch (error) {\n      console.error('Fehler beim Laden der Anwesenheitsdaten:', error);\n      throw error;\n    }\n  },\n\n  addAttendanceEntry: async (entry: AttendanceEntry): Promise<AttendanceEntry> => {\n    try {\n      const newEntry = await api.addAttendanceEntry(entry);\n      notifyDataChange();\n      return newEntry;\n    } catch (error) {\n      console.error('Fehler beim Speichern der Anwesenheit:', error);\n      throw error;\n    }\n  },\n\n  deleteAttendanceEntry: async (employeeId: string, date: string): Promise<void> => {\n    try {\n      await api.deleteAttendanceEntry(employeeId, date);\n      notifyDataChange();\n    } catch (error) {\n      console.error('Fehler beim Löschen der Anwesenheit:', error);\n      throw error;\n    }\n  },\n\n  getAttendanceForDate: async (date: string): Promise<AttendanceEntry[]> => {\n    try {\n      const attendance = await storage.getAttendance();\n      return attendance.filter(entry => entry.date === date);\n    } catch (error) {\n      console.error('Fehler beim Laden der Anwesenheit für Datum:', error);\n      throw error;\n    }\n  },\n\n  getAttendanceForEmployee: async (employeeId: string, startDate?: string, endDate?: string): Promise<AttendanceEntry[]> => {\n    try {\n      const attendance = await storage.getAttendance();\n      return attendance.filter(entry => {\n        if (entry.employeeId !== employeeId) return false;\n        if (startDate && entry.date < startDate) return false;\n        if (endDate && entry.date > endDate) return false;\n        return true;\n      });\n    } catch (error) {\n      console.error('Fehler beim Laden der Anwesenheit für Mitarbeiter:', error);\n      throw error;\n    }\n  },\n\n  // Alte Anwesenheitsdaten bereinigen (älter als 1 Woche)\n  cleanOldAttendanceData: (attendance: AttendanceEntry[]): AttendanceEntry[] => {\n    const oneWeekAgo = startOfWeek(subWeeks(new Date(), 1), { weekStartsOn: 1 });\n    const cutoffDate = format(oneWeekAgo, 'yyyy-MM-dd');\n    \n    return attendance.filter(entry => entry.date >= cutoffDate);\n  },\n\n  // Anwesenheitsdaten für nicht existierende Mitarbeiter bereinigen\n  cleanOrphanedAttendanceData: async (): Promise<void> => {\n    try {\n      const employees = await storage.getEmployees();\n      const attendance = await storage.getAttendance();\n      const employeeIds = employees.map(emp => emp.id);\n      \n      const cleanedAttendance = attendance.filter(entry => \n        employeeIds.includes(entry.employeeId)\n      );\n      \n      if (cleanedAttendance.length !== attendance.length) {\n        console.log('Bereinige verwaiste Anwesenheitsdaten:', {\n          before: attendance.length,\n          after: cleanedAttendance.length,\n          removed: attendance.length - cleanedAttendance.length\n        });\n        // Hier könnten wir einen API-Endpunkt für das Massen-Update hinzufügen\n        // Für jetzt ignorieren wir das, da es selten vorkommt\n      }\n    } catch (error) {\n      console.error('Fehler beim Bereinigen verwaister Anwesenheitsdaten:', error);\n    }\n  },\n};\n\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}